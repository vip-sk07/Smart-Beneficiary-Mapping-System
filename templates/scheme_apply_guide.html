<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Apply â€” {{ scheme.scheme_name }} | BenefitBridge</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Sora:wght@400;600;700;800&family=DM+Sans:wght@300;400;500&display=swap" rel="stylesheet">
    <style>
        :root {
            --saffron: #FF6B00; --saffron-light: #FF8C38; --navy: #0A1628;
            --navy-mid: #162035; --navy-card: #1C2A40; --gold: #F5A623;
            --india-green: #138808; --border: rgba(255,255,255,0.08);
        }
        * { box-sizing: border-box; }
        body { font-family: 'DM Sans', sans-serif; background: var(--navy); color: #fff; min-height: 100vh; }
        .sidebar { position: fixed; left: 0; top: 0; bottom: 0; width: 220px; background: var(--navy-mid); border-right: 1px solid var(--border); display: flex; flex-direction: column; padding: 1.5rem 1rem; z-index: 100; }
        .sidebar-logo { display: flex; align-items: center; gap: 0.6rem; font-family: 'Sora', sans-serif; font-weight: 700; color: #fff; text-decoration: none; margin-bottom: 2.5rem; padding: 0 0.5rem; }
        .logo-dot { width: 30px; height: 30px; border-radius: 8px; background: linear-gradient(135deg, var(--saffron), var(--gold)); display: flex; align-items: center; justify-content: center; font-size: 1rem; }
        .nav-item { display: flex; align-items: center; gap: 0.7rem; padding: 0.65rem 0.75rem; border-radius: 10px; color: rgba(255,255,255,0.5); text-decoration: none; font-size: 0.9rem; transition: all 0.2s; margin-bottom: 0.25rem; }
        .nav-item:hover { background: rgba(255,107,0,0.1); color: #fff; }
        .nav-item i { font-size: 1rem; width: 18px; }
        .nav-spacer { flex: 1; }
        .user-chip { background: rgba(255,255,255,0.05); border: 1px solid var(--border); border-radius: 12px; padding: 0.75rem; }
        .user-chip .name { font-size: 0.88rem; font-weight: 600; color: #fff; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .user-chip .email { font-size: 0.75rem; color: rgba(255,255,255,0.35); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .main { margin-left: 220px; padding: 2rem 2.5rem; min-height: 100vh; }
        .btn-back { display: inline-flex; align-items: center; gap: 0.4rem; color: rgba(255,255,255,0.45); text-decoration: none; font-size: 0.88rem; padding: 0.4rem 0.75rem; border-radius: 8px; border: 1px solid rgba(255,255,255,0.1); transition: all 0.2s; margin-bottom: 1.75rem; }
        .btn-back:hover { color: #fff; border-color: rgba(255,255,255,0.3); background: rgba(255,255,255,0.04); }
        .scheme-header { background: var(--navy-mid); border: 1px solid var(--border); border-radius: 16px; padding: 2rem; margin-bottom: 1.5rem; }
        .scheme-badge { display: inline-flex; align-items: center; gap: 0.35rem; background: rgba(19,136,8,0.12); border: 1px solid rgba(19,136,8,0.25); border-radius: 100px; padding: 0.2rem 0.75rem; font-size: 0.72rem; color: #6ee75f; margin-bottom: 0.75rem; width: fit-content; }
        .scheme-title { font-family: 'Sora', sans-serif; font-size: 1.5rem; font-weight: 800; margin-bottom: 0.5rem; }
        .scheme-desc { color: rgba(255,255,255,0.5); font-size: 0.92rem; line-height: 1.6; max-width: 600px; }
        .scheme-tags { display: flex; gap: 0.5rem; flex-wrap: wrap; margin-top: 1rem; }
        .tag { font-size: 0.75rem; padding: 0.3rem 0.7rem; border-radius: 8px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); color: rgba(255,255,255,0.5); }
        .tag.green { color: #6ee75f; border-color: rgba(110,231,95,0.2); background: rgba(110,231,95,0.05); }
        .tag.gold  { color: var(--gold); border-color: rgba(245,166,35,0.2); background: rgba(245,166,35,0.05); }
        .benefits-box { background: linear-gradient(135deg,rgba(19,136,8,0.1),rgba(19,136,8,0.04)); border: 1px solid rgba(19,136,8,0.25); border-radius: 12px; padding: 1rem 1.25rem; margin-top: 1.25rem; }
        .benefits-label { font-size: 0.72rem; font-weight: 700; letter-spacing: 0.08em; text-transform: uppercase; color: #6ee75f; margin-bottom: 0.3rem; }
        .benefits-value { font-family: 'Sora', sans-serif; font-size: 1rem; font-weight: 700; color: #fff; }
        .guide-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; }
        @media (max-width: 900px) { .guide-grid { grid-template-columns: 1fr; } }
        .guide-card { background: var(--navy-card); border: 1px solid var(--border); border-radius: 14px; padding: 1.5rem; height: fit-content; }
        .guide-card-title { font-family: 'Sora', sans-serif; font-size: 0.8rem; font-weight: 700; letter-spacing: 0.08em; text-transform: uppercase; color: rgba(255,255,255,0.35); margin-bottom: 1.25rem; display: flex; align-items: center; gap: 0.5rem; }
        .step-list { list-style: none; padding: 0; margin: 0; }
        .step-item { display: flex; gap: 1rem; padding: 0.85rem 0; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .step-item:last-child { border-bottom: none; padding-bottom: 0; }
        .step-num { width: 28px; height: 28px; border-radius: 50%; flex-shrink: 0; background: rgba(255,107,0,0.15); border: 1px solid rgba(255,107,0,0.3); display: flex; align-items: center; justify-content: center; font-family: 'Sora', sans-serif; font-size: 0.78rem; font-weight: 700; color: var(--saffron); }
        .step-text { font-size: 0.88rem; color: rgba(255,255,255,0.7); line-height: 1.5; padding-top: 0.2rem; }
        .step-text strong { color: #fff; }
        .data-row { display: flex; justify-content: space-between; align-items: center; padding: 0.65rem 0; border-bottom: 1px solid rgba(255,255,255,0.05); font-size: 0.85rem; }
        .data-row:last-child { border-bottom: none; }
        .data-label { color: rgba(255,255,255,0.35); font-size: 0.78rem; }
        .data-value { color: #fff; font-weight: 500; text-align: right; }
        .data-value.masked { font-family: monospace; letter-spacing: 0.05em; color: rgba(255,255,255,0.6); }
        .btn-copy-all { display: flex; align-items: center; justify-content: center; gap: 0.5rem; width: 100%; padding: 0.65rem; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 9px; color: rgba(255,255,255,0.6); font-size: 0.83rem; cursor: pointer; transition: all 0.2s; margin-top: 1rem; }
        .btn-copy-all:hover { background: rgba(255,255,255,0.09); color: #fff; border-color: rgba(255,255,255,0.2); }
        .btn-copy-all.copied { background: rgba(19,136,8,0.12); border-color: rgba(19,136,8,0.3); color: #6ee75f; }
        .notice { background: rgba(245,166,35,0.07); border: 1px solid rgba(245,166,35,0.2); border-radius: 10px; padding: 0.85rem 1rem; font-size: 0.82rem; color: rgba(245,166,35,0.85); display: flex; gap: 0.6rem; align-items: flex-start; margin-top: 1rem; }
        .notice i { font-size: 0.9rem; flex-shrink: 0; margin-top: 0.1rem; }
        .flash-alert { border-radius: 10px; padding: 0.8rem 1.1rem; font-size: 0.88rem; margin-bottom: 1.5rem; display: flex; align-items: flex-start; gap: 0.6rem; }
        .flash-alert.success { background: rgba(19,136,8,0.1); border: 1px solid rgba(19,136,8,0.25); color: #6ee75f; }
        .flash-alert.info    { background: rgba(255,107,0,0.08); border: 1px solid rgba(255,107,0,0.2); color: var(--saffron-light); }
        .flash-alert.error   { background: rgba(220,53,69,0.1); border: 1px solid rgba(220,53,69,0.25); color: #f87171; }

        /* â”€â”€ 3-Step Apply Flow â”€â”€ */
        .apply-flow { background: var(--navy-mid); border: 1px solid var(--border); border-radius: 14px; padding: 1.75rem 2rem; margin-top: 1.5rem; }
        .apply-flow-title { font-family: 'Sora', sans-serif; font-size: 1rem; font-weight: 700; margin-bottom: 1.5rem; }
        .flow-steps { display: flex; gap: 0; margin-bottom: 1.5rem; }
        .flow-step { flex: 1; text-align: center; position: relative; }
        .flow-step:not(:last-child)::after { content: ''; position: absolute; top: 18px; left: 60%; right: -40%; height: 2px; background: rgba(255,255,255,0.1); }
        .flow-step.active:not(:last-child)::after { background: var(--india-green); }
        .flow-dot { width: 36px; height: 36px; border-radius: 50%; margin: 0 auto 0.5rem; display: flex; align-items: center; justify-content: center; font-family: 'Sora', sans-serif; font-weight: 700; font-size: 0.85rem; border: 2px solid rgba(255,255,255,0.15); color: rgba(255,255,255,0.3); }
        .flow-step.active .flow-dot { background: var(--india-green); border-color: var(--india-green); color: #fff; }
        .flow-step.done .flow-dot { background: var(--india-green); border-color: var(--india-green); color: #fff; }
        .flow-label { font-size: 0.72rem; color: rgba(255,255,255,0.35); font-family: 'Sora', sans-serif; font-weight: 600; }
        .flow-step.active .flow-label { color: #fff; }

        /* checklist */
        .checklist { list-style: none; padding: 0; margin: 0 0 1.5rem; }
        .checklist li { display: flex; align-items: center; gap: 0.75rem; padding: 0.65rem 0.75rem; border-radius: 9px; background: rgba(19,136,8,0.06); border: 1px solid rgba(19,136,8,0.15); margin-bottom: 0.5rem; font-size: 0.88rem; }
        .checklist li i { color: #6ee75f; font-size: 1rem; }

        /* already-applied banner */
        .already-applied { background: rgba(245,166,35,0.08); border: 1px solid rgba(245,166,35,0.2); border-radius: 12px; padding: 1.25rem 1.5rem; display: flex; align-items: center; gap: 1rem; }
        .already-applied i { font-size: 1.5rem; color: var(--gold); flex-shrink: 0; }

        .btn-submit-app { display: inline-flex; align-items: center; justify-content: center; gap: 0.6rem; padding: 0.85rem 2rem; background: var(--india-green); color: #fff; border: none; border-radius: 12px; font-family: 'Sora', sans-serif; font-weight: 700; font-size: 0.95rem; cursor: pointer; transition: all 0.2s; width: 100%; }
        .btn-submit-app:hover { background: #0fa806; transform: translateY(-1px); box-shadow: 0 6px 20px rgba(19,136,8,0.3); }
        .btn-go { display: inline-flex; align-items: center; gap: 0.5rem; padding: 0.75rem 1.75rem; background: transparent; color: rgba(255,255,255,0.6); border: 1px solid rgba(255,255,255,0.15); border-radius: 10px; font-size: 0.88rem; text-decoration: none; transition: all 0.2s; white-space: nowrap; }
        .btn-go:hover { border-color: rgba(255,255,255,0.35); color: #fff; }

        @media (max-width: 768px) { .sidebar { display: none; } .main { margin-left: 0; padding: 1.5rem 1rem; } }
    </style>
</head>
<body>
<nav class="sidebar">
    <a href="{% url 'home' %}" class="sidebar-logo">
        <div class="logo-dot">ðŸ‡®ðŸ‡³</div>
        BenefitBridge
    </a>
    <a href="{% url 'dashboard' %}" class="nav-item"><i class="bi bi-grid-1x2"></i> Dashboard</a>
    <a href="{% url 'categories' %}" class="nav-item"><i class="bi bi-search"></i> Search Schemes</a>
    <a href="{% url 'my_applications' %}" class="nav-item"><i class="bi bi-file-earmark-check"></i> My Applications</a>
    <a href="{% url 'my_grievances' %}" class="nav-item"><i class="bi bi-exclamation-circle"></i> My Grievances</a>
    <div class="nav-spacer"></div>
    <div class="user-chip">
        <div class="name">{{ user.name }}</div>
        <div class="email">{{ user.email }}</div>
        <a href="{% url 'logout' %}" class="nav-item mt-2" style="padding:0.4rem 0;color:rgba(248,113,113,0.6);">
            <i class="bi bi-box-arrow-right"></i> Sign out
        </a>
    </div>
</nav>

<main class="main">
    <a href="{% url 'dashboard' %}" class="btn-back"><i class="bi bi-arrow-left"></i> Back to Dashboard</a>

    {% if messages %}
        {% for message in messages %}
            <div class="flash-alert {% if 'success' in message.tags %}success{% elif 'error' in message.tags %}error{% else %}info{% endif %}">
                <i class="bi {% if 'success' in message.tags %}bi-check-circle-fill{% elif 'error' in message.tags %}bi-x-circle-fill{% else %}bi-info-circle-fill{% endif %}"></i>
                <span>{{ message }}</span>
            </div>
        {% endfor %}
    {% endif %}

    <!-- Scheme Header -->
    <div class="scheme-header">
        <div class="scheme-badge"><i class="bi bi-check-circle-fill"></i> You are Eligible</div>
        <div class="scheme-title">{{ scheme.scheme_name }}</div>
        <div class="scheme-desc">{{ scheme.description }}</div>
        <div class="scheme-tags">
            {% if scheme.state %}<span class="tag gold"><i class="bi bi-geo-alt-fill"></i> {{ scheme.state }}</span>{% endif %}
            {% if scheme.benefit_type %}<span class="tag green">{{ scheme.benefit_type }}</span>{% endif %}
            <span class="tag">Government Scheme</span>
        </div>
        {% if scheme.benefits %}
        <div class="benefits-box">
            <div class="benefits-label"><i class="bi bi-gift-fill"></i> What You Get</div>
            <div class="benefits-value">{{ scheme.benefits }}</div>
        </div>
        {% endif %}
    </div>

    <!-- Two-column guide -->
    <div class="guide-grid">
        <!-- LEFT: How to Apply Steps -->
        <div class="guide-card">
            <div class="guide-card-title"><i class="bi bi-list-ol"></i> How to Apply â€” Step by Step</div>
            <ol class="step-list">
                <li class="step-item"><div class="step-num">1</div><div class="step-text"><strong>Copy your details</strong> from the panel on the right. Keep this tab open â€” you'll need them to fill the form.</div></li>
                <li class="step-item"><div class="step-num">2</div><div class="step-text">Click <strong>"Submit Application"</strong> below to register your intent on BenefitBridge.</div></li>
                <li class="step-item"><div class="step-num">3</div><div class="step-text">Click <strong>"Go to Official Portal"</strong> to open the government website in a new tab.</div></li>
                <li class="step-item"><div class="step-num">4</div><div class="step-text"><strong>Register / Log in</strong> on the portal using your Aadhaar number or mobile linked to Aadhaar.</div></li>
                <li class="step-item"><div class="step-num">5</div><div class="step-text">Fill in your <strong>personal details</strong> (name, DOB, Aadhaar, income, address) using the data from the right panel.</div></li>
                <li class="step-item"><div class="step-num">6</div><div class="step-text"><strong>Upload documents</strong> â€” typically: Aadhaar, income certificate, bank passbook, and a passport photo.</div></li>
                <li class="step-item"><div class="step-num">7</div><div class="step-text"><strong>Submit</strong> on the portal and note your government reference number.</div></li>
            </ol>
            <div class="notice"><i class="bi bi-info-circle-fill"></i> Government portals may ask you to verify via OTP sent to your Aadhaar-linked mobile number. Keep your phone nearby.</div>
        </div>

        <!-- RIGHT: Your Pre-filled Details -->
        <div>
            <div class="guide-card">
                <div class="guide-card-title"><i class="bi bi-person-vcard"></i> Your Details â€” Ready to Fill</div>
                <div class="data-row"><span class="data-label">Full Name</span><span class="data-value" id="val-name">{{ user.name }}</span></div>
                <div class="data-row"><span class="data-label">Date of Birth</span><span class="data-value">{{ user.dob|date:"d/m/Y" }}</span></div>
                <div class="data-row"><span class="data-label">Gender</span><span class="data-value">{{ user.gender|default:"â€”" }}</span></div>
                <div class="data-row"><span class="data-label">Email</span><span class="data-value">{{ user.email|default:"â€”" }}</span></div>
                <div class="data-row"><span class="data-label">Phone</span><span class="data-value">{{ user.phone|default:"â€”" }}</span></div>
                <div class="data-row"><span class="data-label">Aadhaar No.</span><span class="data-value masked" id="val-aadhaar">{{ user.aadhaar_no }}</span></div>
                <div class="data-row"><span class="data-label">Address</span><span class="data-value" style="max-width:55%;text-align:right;">{{ user.address|default:"â€”" }}</span></div>
                <div class="data-row"><span class="data-label">Annual Income</span><span class="data-value">{% if user.income %}â‚¹{{ user.income|floatformat:0 }}{% else %}â€”{% endif %}</span></div>
                <div class="data-row"><span class="data-label">Occupation</span><span class="data-value">{{ user.occupation|default:"â€”" }}</span></div>
                <div class="data-row"><span class="data-label">Education</span><span class="data-value">{{ user.education|default:"â€”" }}</span></div>
                <button class="btn-copy-all" id="copyAllBtn" onclick="copyAllDetails()">
                    <i class="bi bi-clipboard"></i> Copy All Details
                </button>
                <div class="notice" style="margin-top:0.75rem;"><i class="bi bi-shield-check"></i> Your data is only shown here to help you fill the form. Nothing is sent automatically.</div>
            </div>
        </div>
    </div>

    <!-- â”€â”€ 3-Step Application Flow â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
    <div class="apply-flow">
        <div class="apply-flow-title">
            <i class="bi bi-send-check me-2" style="color:var(--india-green);"></i>
            Submit Your Application on BenefitBridge
        </div>

        <!-- Step indicators -->
        <div class="flow-steps">
            <div class="flow-step {% if not existing_app %}active{% else %}done{% endif %}">
                <div class="flow-dot">{% if existing_app %}<i class="bi bi-check-lg"></i>{% else %}1{% endif %}</div>
                <div class="flow-label">Eligibility</div>
            </div>
            <div class="flow-step {% if existing_app %}active{% endif %}">
                <div class="flow-dot">{% if existing_app %}<i class="bi bi-check-lg"></i>{% else %}2{% endif %}</div>
                <div class="flow-label">Submit</div>
            </div>
            <div class="flow-step {% if existing_app %}done{% endif %}">
                <div class="flow-dot">3</div>
                <div class="flow-label">Track</div>
            </div>
        </div>

        {% if existing_app %}
            <!-- Already applied -->
            <div class="already-applied">
                <i class="bi bi-check-circle-fill"></i>
                <div>
                    <div style="font-family:'Sora',sans-serif;font-weight:700;margin-bottom:0.3rem;">Application Already Submitted</div>
                    <div style="font-size:0.85rem;color:rgba(255,255,255,0.55);">
                        Reference ID: <strong style="color:var(--gold);font-family:monospace;">BB-{{ existing_app.app_id }}</strong> &nbsp;|&nbsp;
                        Status: <strong>{{ existing_app.status }}</strong> &nbsp;|&nbsp;
                        Applied: {{ existing_app.applied_on|date:"d M Y" }}
                    </div>
                    <a href="{% url 'my_applications' %}" style="display:inline-block;margin-top:0.5rem;color:#6ee75f;font-size:0.85rem;font-weight:600;text-decoration:none;">
                        Track in My Applications â†’
                    </a>
                </div>
            </div>
        {% else %}
            <!-- Step 1: Pre-requisite checklist -->
            <ul class="checklist">
                <li><i class="bi bi-check-circle-fill"></i> Aadhaar Identity Verified â€” Profile Complete</li>
                <li><i class="bi bi-check-circle-fill"></i> Eligibility Status Confirmed â€” You Qualify</li>
                <li><i class="bi bi-check-circle-fill"></i> Auto-fill Data Ready â€” Your details will be shown for reference</li>
            </ul>

            <!-- Step 2: Submit button -->
            <form method="POST" action="{% url 'apply_scheme' scheme.scheme_id %}">
                {% csrf_token %}
                <button type="submit" class="btn-submit-app">
                    <i class="bi bi-send-fill"></i> Confirm & Submit Application
                </button>
            </form>
            <p style="font-size:0.78rem;color:rgba(255,255,255,0.3);text-align:center;margin-top:0.75rem;">
                This records your application on BenefitBridge. You still need to apply on the official portal below.
            </p>
        {% endif %}

        <!-- Official portal link always available -->
        {% if apply_url %}
            <div style="margin-top:1.25rem;padding-top:1.25rem;border-top:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:1rem;">
                <div>
                    <div style="font-family:'Sora',sans-serif;font-weight:700;font-size:0.9rem;margin-bottom:0.2rem;">Ready to apply on the government portal?</div>
                    <div style="font-size:0.82rem;color:rgba(255,255,255,0.4);">Opens in a new tab. Keep this page open for your details.</div>
                </div>
                <a href="{{ apply_url }}" target="_blank" rel="noopener" class="btn-go">
                    Go to Official Portal <i class="bi bi-box-arrow-up-right"></i>
                </a>
            </div>
        {% endif %}
    </div>

</main>

<script>
function copyAllDetails() {
    const details = `Name: {{ user.name }}
Date of Birth: {{ user.dob|date:"d/m/Y" }}
Gender: {{ user.gender|default:"â€”" }}
Email: {{ user.email|default:"â€”" }}
Phone: {{ user.phone|default:"â€”" }}
Aadhaar No: {{ user.aadhaar_no }}
Address: {{ user.address|default:"â€”" }}
Annual Income: {% if user.income %}â‚¹{{ user.income|floatformat:0 }}{% else %}â€”{% endif %}
Occupation: {{ user.occupation|default:"â€”" }}
Education: {{ user.education|default:"â€”" }}`;

    navigator.clipboard.writeText(details).then(function() {
        var btn = document.getElementById('copyAllBtn');
        btn.classList.add('copied');
        btn.innerHTML = '<i class="bi bi-check2-circle"></i> Copied!';
        setTimeout(function() {
            btn.classList.remove('copied');
            btn.innerHTML = '<i class="bi bi-clipboard"></i> Copy All Details';
        }, 2500);
    }).catch(function() {
        alert('Copy failed. Please manually select and copy your details.');
    });
}
</script>
</body>
</html>