{% extends "base.html" %}
{% load static %}

{% block title %}Edit Profile — Smart Beneficiary Mapping System{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-12 col-lg-10 col-xl-8">
        
        <div class="mb-4">
            <a href="{% url 'dashboard' %}" class="btn btn-link text-decoration-none p-0 mb-3 text-muted fw-semibold" style="font-size: 0.85rem;">
                <i class="bi bi-arrow-left me-1"></i> Back to Dashboard
            </a>
            <h1 class="h3 fw-bold mb-1 text-dark">
                <i class="bi bi-person-gear text-primary me-2"></i>Edit Profile
            </h1>
            <p class="text-muted mb-0">Update your personal details. Eligibility will be automatically recalculated after saving.</p>
        </div>

        <div class="bb-card bg-info bg-opacity-10 border-info border-opacity-25 d-flex gap-3 align-items-start mb-4">
            <i class="bi bi-info-circle-fill text-info mt-1"></i>
            <div class="small fw-semibold text-dark text-opacity-75">
                Aadhaar number and email cannot be changed securely. Contact official support if you require these to be updated.
            </div>
        </div>

        <div class="bb-card p-4 p-md-5">
            <form method="POST" novalidate>
                {% csrf_token %}
                
                <!-- Locked Fields Section -->
                <h6 class="fw-bold text-uppercase text-muted mb-3" style="font-size: 0.75rem; letter-spacing: 0.05em;">
                    <i class="bi bi-lock-fill me-1"></i> Locked Identity Verification
                </h6>
                <div class="row g-3 mb-4 pb-4 border-bottom">
                    <div class="col-md-6">
                        <label class="form-label fw-bold text-muted small mb-1">Registered Email <i class="bi bi-lock text-muted ms-1"></i></label>
                        <div class="form-control bg-light text-muted fw-semibold" style="cursor: not-allowed; border-color: transparent;">
                            {{ user.email|default:"—" }}
                        </div>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label fw-bold text-muted small mb-1">Aadhaar No. <i class="bi bi-lock text-muted ms-1"></i></label>
                        <div class="form-control bg-light text-muted fw-semibold" style="cursor: not-allowed; border-color: transparent; letter-spacing: 0.1em;">
                            XXXX-XXXX-{{ user.aadhaar_no|slice:"-4:"|default:"——" }}
                        </div>
                    </div>
                </div>

                <!-- Editable Fields Section -->
                <h6 class="fw-bold text-uppercase text-primary mb-3" style="font-size: 0.75rem; letter-spacing: 0.05em;">
                    <i class="bi bi-pencil-square me-1"></i> Editable Details
                </h6>
                <div class="row g-3">
                    <div class="col-md-8">
                        <label class="form-label fw-bold small mb-1">Full Name <span class="text-danger">*</span></label>
                        {{ form.name }}
                        {% for e in form.name.errors %}
                        <div class="text-danger small mt-1 fw-semibold"><i class="bi bi-exclamation-circle me-1"></i>{{ e }}</div>
                        {% endfor %}
                    </div>
                    <div class="col-md-4">
                        <label class="form-label fw-bold small mb-1">Date of Birth <span class="text-danger">*</span></label>
                        {{ form.dob }}
                        {% for e in form.dob.errors %}
                        <div class="text-danger small mt-1 fw-semibold"><i class="bi bi-exclamation-circle me-1"></i>{{ e }}</div>
                        {% endfor %}
                    </div>

                    <div class="col-md-4">
                        <label class="form-label fw-bold small mb-1">Gender</label>
                        {{ form.gender }}
                        {% for e in form.gender.errors %}
                        <div class="text-danger small mt-1 fw-semibold"><i class="bi bi-exclamation-circle me-1"></i>{{ e }}</div>
                        {% endfor %}
                    </div>
                    <div class="col-md-8">
                        <label class="form-label fw-bold small mb-1">Phone Number</label>
                        {{ form.phone }}
                        {% for e in form.phone.errors %}
                        <div class="text-danger small mt-1 fw-semibold"><i class="bi bi-exclamation-circle me-1"></i>{{ e }}</div>
                        {% endfor %}
                    </div>

                    <div class="col-12">
                        <label class="form-label fw-bold small mb-1">Address</label>
                        {{ form.address }}
                        {% for e in form.address.errors %}
                        <div class="text-danger small mt-1 fw-semibold"><i class="bi bi-exclamation-circle me-1"></i>{{ e }}</div>
                        {% endfor %}
                    </div>

                    <div class="col-md-4">
                        <label class="form-label fw-bold small mb-1">Annual Income (₹)</label>
                        {{ form.income }}
                        {% for e in form.income.errors %}
                        <div class="text-danger small mt-1 fw-semibold"><i class="bi bi-exclamation-circle me-1"></i>{{ e }}</div>
                        {% endfor %}
                    </div>
                    <div class="col-md-4">
                        <label class="form-label fw-bold small mb-1">Occupation</label>
                        {{ form.occupation }}
                        {% for e in form.occupation.errors %}
                        <div class="text-danger small mt-1 fw-semibold"><i class="bi bi-exclamation-circle me-1"></i>{{ e }}</div>
                        {% endfor %}
                    </div>
                    <div class="col-md-4">
                        <label class="form-label fw-bold small mb-1">Education</label>
                        {{ form.education }}
                        {% for e in form.education.errors %}
                        <div class="text-danger small mt-1 fw-semibold"><i class="bi bi-exclamation-circle me-1"></i>{{ e }}</div>
                        {% endfor %}
                    </div>
                </div>

                <div class="mt-5">
                    <button type="submit" class="bb-btn bb-btn-primary w-100 py-3 d-flex align-items-center justify-content-center gap-2">
                        <i class="bi bi-floppy-fill"></i> Save Changes &amp; Recalculate Eligibility
                    </button>
                    <div class="text-center mt-3">
                        <a href="{% url 'dashboard' %}" class="text-muted text-decoration-none small fw-semibold transition-smooth hover-primary">Cancel</a>
                    </div>
                </div>
            </form>
        </div>

    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', () => {
    // Add bootstrap form-control classes where Django misses it, particularly the select
    const selects = document.querySelectorAll('select');
    selects.forEach(select => select.classList.add('form-select', 'shadow-none'));
    
    const inputs = document.querySelectorAll('input, textarea');
    inputs.forEach(input => {
        if(!input.classList.contains('form-control')) {
            input.classList.add('form-control', 'shadow-none');
        }
    });
});
</script>
{% endblock %}
