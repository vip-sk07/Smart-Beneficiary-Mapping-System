{% extends "base.html" %}
{% load static %}

{% block title %}Manage Grievances â€” Smart Beneficiary Mapping System Admin{% endblock %}

{% block content %}
<div class="mb-4">
    <div class="d-flex flex-wrap align-items-center justify-content-between gap-3">
        <div>
            <h1 class="h3 fw-bold mb-1 text-dark">
                <i class="bi bi-exclamation-triangle-fill text-warning me-2"></i>Manage Grievances
            </h1>
            <p class="text-muted mb-0">Review and resolve user-submitted grievances</p>
        </div>
        <a href="{% url 'admin_stats' %}" class="btn btn-outline-secondary btn-sm px-3 rounded-pill fw-bold">
            <i class="bi bi-bar-chart-fill me-1"></i> Governance Dashboard
        </a>
    </div>
</div>

<!-- KPI Cards -->
<div class="row g-3 mb-4">
    <div class="col-md-4">
        <div class="bb-card p-4 border-top border-4 border-warning h-100">
            <h3 class="fw-bold mb-1 text-dark">{{ open_count }}</h3>
            <p class="text-muted small fw-semibold text-uppercase m-0">Open Grievances</p>
        </div>
    </div>
    <div class="col-md-4">
        <div class="bb-card p-4 border-top border-4 border-success h-100">
            <h3 class="fw-bold mb-1 text-dark">{{ resolved_count }}</h3>
            <p class="text-muted small fw-semibold text-uppercase m-0">Resolved</p>
        </div>
    </div>
    <div class="col-md-4">
        <div class="bb-card p-4 border-top border-4 border-primary h-100">
            <h3 class="fw-bold mb-1 text-dark">{{ open_count|add:resolved_count }}</h3>
            <p class="text-muted small fw-semibold text-uppercase m-0">Total</p>
        </div>
    </div>
</div>

<!-- Filter Tabs -->
<div class="d-flex gap-2 mb-4 overflow-auto pb-2" style="scrollbar-width: none;">
    <a href="?status=Open" class="btn {% if status_filter == 'Open' %}btn-primary shadow-sm{% else %}btn-outline-secondary border-opacity-25{% endif %} rounded-pill px-4 fw-semibold border-2" style="white-space: nowrap;">
        <i class="bi bi-hourglass-split me-1"></i> Open ({{ open_count }})
    </a>
    <a href="?status=Resolved" class="btn {% if status_filter == 'Resolved' %}btn-success text-white shadow-sm{% else %}btn-outline-secondary border-opacity-25{% endif %} rounded-pill px-4 fw-semibold border-2" style="white-space: nowrap;">
        <i class="bi bi-check-circle-fill me-1"></i> Resolved ({{ resolved_count }})
    </a>
    <a href="?status=All" class="btn {% if status_filter == 'All' %}btn-dark text-white shadow-sm{% else %}btn-outline-secondary border-opacity-25{% endif %} rounded-pill px-4 fw-semibold border-2" style="white-space: nowrap;">
        <i class="bi bi-list-ul me-1"></i> All
    </a>
</div>

<div class="bb-card p-0 overflow-hidden mb-5 border-top border-4 border-dark">
    {% if grievances %}
    <div class="table-responsive">
        <table class="table bb-table table-hover align-middle m-0">
            <thead class="bg-light border-bottom">
                <tr>
                    <th scope="col" class="py-3 px-4 text-muted small fw-bold text-uppercase border-0">GRV ID</th>
                    <th scope="col" class="py-3 px-4 text-muted small fw-bold text-uppercase border-0">User Profile</th>
                    <th scope="col" class="py-3 px-4 text-muted small fw-bold text-uppercase border-0">Scheme</th>
                    <th scope="col" class="py-3 px-4 text-muted small fw-bold text-uppercase border-0" style="min-width: 250px;">Complaint Details</th>
                    <th scope="col" class="py-3 px-4 text-muted small fw-bold text-uppercase border-0 text-nowrap">Status</th>
                    <th scope="col" class="py-3 px-4 text-muted small fw-bold text-uppercase border-0 text-nowrap">Action</th>
                </tr>
            </thead>
            <tbody>
                {% for g in grievances %}
                <tr>
                    <td class="px-4 py-3">
                        <span class="font-monospace fw-bold text-accent">GRV-{{ g.grievance_id }}</span>
                        <div class="text-muted mt-1" style="font-size: 0.75rem;">{{ g.raised_on|date:"d M Y" }}</div>
                    </td>
                    <td class="px-4 py-3">
                        <div class="fw-bold text-dark">{{ g.user.name }}</div>
                        <div class="text-muted" style="font-size: 0.8rem;">{{ g.user.email }}</div>
                    </td>
                    <td class="px-4 py-3">
                        <span class="bb-tag">{{ g.scheme.scheme_name|default:"General Issue"|truncatechars:35 }}</span>
                    </td>
                    <td class="px-4 py-3">
                        <div class="text-muted small ps-2 border-start border-3 border-warning border-opacity-50" style="line-height: 1.5; font-style: italic;">
                            "{{ g.complaint }}"
                        </div>
                    </td>
                    <td class="px-4 py-3 text-nowrap">
                        {% if g.status == 'Resolved' %}
                        <span class="bb-badge bb-badge-success"><i class="bi bi-check-circle-fill me-1"></i>Resolved</span>
                        {% else %}
                        <span class="bb-badge bb-badge-warning"><i class="bi bi-hourglass-split me-1"></i>Open</span>
                        {% endif %}
                    </td>
                    <td class="px-4 py-3 text-end text-nowrap">
                        {% if g.status == 'Open' %}
                        <button class="btn btn-sm btn-success text-white fw-bold rounded-pill px-3 shadow-sm" onclick="openModal({{ g.grievance_id }}, '{{ g.user.name|escapejs }}', '{{ g.scheme.scheme_name|default:'General'|escapejs }}')">
                            <i class="bi bi-check-lg me-1"></i> Resolve
                        </button>
                        {% else %}
                        <div class="text-success small fw-medium pb-1 d-inline-block border-bottom border-success border-opacity-25 border-1 text-wrap text-start mt-2" style="max-width: 180px;">
                            {{ g.admin_remark|default:"Resolved"|truncatechars:40 }}
                        </div>
                        {% if g.resolved_on %}
                        <div class="text-muted mt-1" style="font-size: 0.7rem;">{{ g.resolved_on|date:"d M Y" }}</div>
                        {% endif %}
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <div class="text-center p-5">
        <div class="display-3 text-muted mb-3"><i class="bi bi-emoji-smile"></i></div>
        <h5 class="fw-bold text-dark">Inbox Zero!</h5>
        <p class="text-muted mb-0">No grievances found matching this filter.</p>
    </div>
    {% endif %}
</div>

<!-- Resolve Modal Overlay (Native HTML/Vanilla JS) -->
<div class="modal fade" id="resolveModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg rounded-4 overflow-hidden bb-card">
            <div class="modal-header bg-light border-bottom p-4">
                <h5 class="modal-title fw-bold text-dark"><i class="bi bi-check-circle-fill text-success me-2"></i>Resolve Grievance</h5>
                <button type="button" class="btn-close shadow-none" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-4">
                <p class="text-muted small fw-semibold mb-3" id="modalSub">Enter your resolution remark for this grievance.</p>
                <form id="resolveForm" method="POST" action="">
                    {% csrf_token %}
                    <label class="form-label fw-bold text-uppercase" style="font-size: 0.75rem; letter-spacing: 0.05em;">Admin Remark</label>
                    <textarea name="admin_remark" class="form-control shadow-none border-2" placeholder="Enter resolution remark (optional)..." id="remarkTextarea" rows="4"></textarea>
                    
                    <div class="d-flex gap-2 mt-4 pt-2">
                        <button type="button" class="btn btn-outline-secondary fw-bold rounded-pill w-50" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-success text-white fw-bold rounded-pill w-50 shadow-sm"><i class="bi bi-check-lg me-1"></i> Mark Resolved</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
    let resolveModalInstance = null;

    document.addEventListener('DOMContentLoaded', () => {
        // Initialize Bootstrap modal if available
        if (typeof bootstrap !== 'undefined') {
            resolveModalInstance = new bootstrap.Modal(document.getElementById('resolveModal'));
        }
    });

    function openModal(grvId, userName, schemeName) {
        document.getElementById('resolveForm').action = '/platform-admin/grievances/' + grvId + '/resolve/';
        document.getElementById('modalSub').innerHTML = `Resolving <span class="fw-bold text-dark">GRV-${grvId}</span> for <span class="text-primary fw-medium">${userName}</span> (${schemeName})`;

        document.getElementById('remarkTextarea').value = '';
        
        if (resolveModalInstance) {
            resolveModalInstance.show();
        } else {
            console.error("Bootstrap modal is not initialized.");
            // Fallback for vanilla functionality if required
        }
    }
</script>
{% endblock %}