{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Dashboard ‚Äî Smart Beneficiary Mapping System{% endblock %}</title>

    <!-- Apply dark mode BEFORE render to prevent flash of white -->
    <script>
        if (localStorage.getItem('sbms-dark') === '1') {
            document.documentElement.classList.add('dark-mode');
        }
    </script>

    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

    <!-- Bootstrap 5.3 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">

    <!-- Premium CSS System -->
    <link href="{% static 'css/benefitbridge_premium.css' %}" rel="stylesheet">

    <!-- Dark Mode Inline Styles (inlined so always loads regardless of staticfiles) -->
    <style>
        /* ‚îÄ‚îÄ Dark Mode Variables ‚îÄ‚îÄ */
        html.dark-mode {
            --canvas: #0F172A !important;
            --surface: #1E293B !important;
            --text-main: #F1F5F9 !important;
            --text-muted: #94A3B8 !important;
            --text-light: #64748B !important;
            --border: #334155 !important;
            --primary-light: #1E1B4B !important;
            --success-bg: #052E1C !important; --success-text: #6EE7B7 !important;
            --warning-bg: #2D1A00 !important; --warning-text: #FCD34D !important;
            --danger-bg: #2D0A0A !important;  --danger-text: #FCA5A5 !important;
        }
        html.dark-mode body {
            background-color: #0F172A !important;
            color: #F1F5F9 !important;
        }
        html.dark-mode .bb-sidebar     { background: #1E293B !important; border-color: #334155 !important; }
        html.dark-mode .bb-navbar       { background: rgba(15,23,42,0.95) !important; border-color: #334155 !important; }
        html.dark-mode .bb-card         { background: #1E293B !important; border-color: #334155 !important; }
        html.dark-mode .bg-white        { background-color: #1E293B !important; }
        html.dark-mode .bg-light        { background-color: #263044 !important; }
        html.dark-mode .card            { background: #1E293B !important; border-color: #334155 !important; }
        html.dark-mode .form-control,
        html.dark-mode .form-select     { background: #1E293B !important; border-color: #334155 !important; color: #F1F5F9 !important; }
        html.dark-mode .form-control::placeholder { color: #64748B !important; }
        html.dark-mode .input-group-text{ background: #1E293B !important; border-color: #334155 !important; color: #94A3B8 !important; }
        html.dark-mode .table           { color: #F1F5F9 !important; }
        html.dark-mode .table-light th  { background: #263044 !important; color: #94A3B8 !important; }
        html.dark-mode .table-hover tbody tr:hover { background: rgba(99,102,241,0.1) !important; }
        html.dark-mode .border          { border-color: #334155 !important; }
        html.dark-mode .border-top,
        html.dark-mode .border-bottom   { border-color: #334155 !important; }
        html.dark-mode .text-dark       { color: #F1F5F9 !important; }
        html.dark-mode .text-muted      { color: #94A3B8 !important; }
        html.dark-mode .fw-semibold[style*="#0F172A"],
        html.dark-mode [style*="color: #0F172A"],
        html.dark-mode [style*="color:#0F172A"] { color: #F1F5F9 !important; }
        html.dark-mode .alert           { background: #1E293B !important; border-color: #334155 !important; }
        html.dark-mode .bb-nav-item     { color: #94A3B8 !important; }
        html.dark-mode .bb-nav-item:hover,
        html.dark-mode .bb-nav-item.active { background: rgba(99,102,241,0.15) !important; color: #818CF8 !important; }
        html.dark-mode .shadow-sm,
        html.dark-mode .shadow,
        html.dark-mode .shadow-lg       { box-shadow: 0 4px 12px rgba(0,0,0,0.5) !important; }
        html.dark-mode .bb-stat-card    { background: #1E293B !important; }

        /* Dark mode toggle */
        .dark-toggle {
            display: flex; align-items: center; justify-content: space-between;
            padding: 0.55rem 0.75rem; border-radius: 10px;
            cursor: pointer; user-select: none;
            color: var(--text-muted); font-size: 0.85rem; font-weight: 600;
            margin-bottom: 0.5rem; transition: background 0.2s;
        }
        .dark-toggle:hover { background: var(--primary-light); color: var(--primary); }
        .dark-toggle-switch {
            width: 40px; height: 22px; border-radius: 11px;
            background: #CBD5E1; position: relative; transition: background 0.3s; flex-shrink:0;
        }
        .dark-toggle-switch::after {
            content: ''; position: absolute; top: 3px; left: 3px;
            width: 16px; height: 16px; border-radius: 50%;
            background: white; transition: transform 0.25s;
            box-shadow: 0 1px 3px rgba(0,0,0,0.25);
        }
        html.dark-mode .dark-toggle-switch { background: #4F46E5; }
        html.dark-mode .dark-toggle-switch::after { transform: translateX(18px); }
        html.dark-mode .dark-toggle { color: #818CF8; }

        /* Smooth fade between modes */
        body, .bb-card, .bb-sidebar, .bb-navbar, .form-control, .form-select {
            transition: background-color 0.25s ease, color 0.2s ease, border-color 0.2s ease !important;
        }
    </style>

    {% block extra_css %}{% endblock %}
</head>
<body>

    <!-- Mobile Top Navbar -->
    <nav class="bb-navbar">
        <a href="{% url 'dashboard' %}" class="d-flex align-items-center text-decoration-none" style="gap: 0.6rem; color: #0F172A; font-weight: 700; font-size: 0.95rem;">
            <div style="width:34px; height:34px; border-radius:8px; background: var(--primary); display:flex; align-items:center; justify-content:center; flex-shrink:0; box-shadow: 0 2px 8px rgba(30,58,138,0.25);">
                <i class="bi bi-bank2" style="font-size: 1.1rem; color: white;"></i>
            </div>
            <span style="line-height:1.2;">Smart Beneficiary<br><span style="font-size:0.75rem; font-weight:500; color:var(--text-light);">Mapping System</span></span>
        </a>
        <button id="bb-sidebar-toggle" class="bb-btn" style="padding: 0.5rem; color: var(--text-main); background: transparent; box-shadow: none;">
            <i class="bi bi-list fs-4"></i>
        </button>
    </nav>

    <!-- Sidebar -->
    <aside class="bb-sidebar">
        <div class="d-flex flex-column" style="padding: 1.5rem 1rem; flex: 1; overflow-y: auto;">
            <!-- Logo -->
            <a href="{% url 'dashboard' %}" class="d-flex align-items-center text-decoration-none mb-4" style="gap: 0.75rem; color: #0F172A; font-weight: 700; font-size: 1rem;">
                <div style="width:42px; height:42px; border-radius:10px; background: var(--primary); display:flex; align-items:center; justify-content:center; flex-shrink:0; box-shadow: 0 4px 12px rgba(30,58,138,0.3);">
                    <i class="bi bi-bank2" style="font-size: 1.3rem; color: white;"></i>
                </div>
                <span style="line-height:1.25;">Smart Beneficiary<br><span style="font-size:0.75rem; font-weight:500; color:var(--text-light); letter-spacing:0.01em;">Mapping System</span></span>
            </a>

            <!-- Navigation Links -->
            <nav class="d-flex flex-column" style="gap: 0.25rem;">
                {% if not request.user.is_superuser %}
                <a href="{% url 'dashboard' %}" class="bb-nav-item {% if request.resolver_match.url_name == 'dashboard' %}active{% endif %}">
                    <i class="bi bi-grid-1x2"></i> Dashboard
                </a>
                <a href="{% url 'categories' %}" class="bb-nav-item {% if request.resolver_match.url_name == 'categories' %}active{% endif %}">
                    <i class="bi bi-search"></i> Search Schemes
                </a>
                <a href="{% url 'my_applications' %}" class="bb-nav-item {% if request.resolver_match.url_name == 'my_applications' %}active{% endif %}">
                    <i class="bi bi-file-earmark-check"></i> My Applications
                </a>
                <a href="{% url 'my_grievances' %}" class="bb-nav-item {% if request.resolver_match.url_name == 'my_grievances' %}active{% endif %}">
                    <i class="bi bi-exclamation-circle"></i> My Grievances
                </a>
                <a href="{% url 'edit_profile' %}" class="bb-nav-item {% if request.resolver_match.url_name == 'edit_profile' %}active{% endif %}">
                    <i class="bi bi-person-badge"></i> Edit Profile
                </a>
                {% endif %}
                {% if request.user.is_superuser %}
                <div class="mt-3 mb-2 px-3 text-uppercase" style="font-size: 0.7rem; font-weight: 700; color: var(--text-light); letter-spacing: 0.05em;">Admin</div>
                <a href="{% url 'admin_stats' %}" class="bb-nav-item {% if request.resolver_match.url_name == 'admin_stats' %}active{% endif %}">
                    <i class="bi bi-pie-chart"></i> Platform Stats
                </a>
                <a href="{% url 'admin_users' %}" class="bb-nav-item {% if request.resolver_match.url_name == 'admin_users' %}active{% endif %}">
                    <i class="bi bi-people"></i> Manage Users
                </a>
                <a href="{% url 'admin_schemes' %}" class="bb-nav-item {% if 'scheme' in request.resolver_match.url_name %}active{% endif %}">
                    <i class="bi bi-card-list"></i> Manage Schemes
                </a>
                <a href="{% url 'admin_grievances' %}" class="bb-nav-item {% if request.resolver_match.url_name == 'admin_grievances' %}active{% endif %}">
                    <i class="bi bi-inbox"></i> Manage Grievances
                </a>
                <a href="{% url 'admin_announcements' %}" class="bb-nav-item {% if request.resolver_match.url_name == 'admin_announcements' %}active{% endif %}">
                    <i class="bi bi-megaphone"></i> Announcements
                </a>
                <a href="/admin/" class="bb-nav-item">
                    <i class="bi bi-gear"></i> Django Admin
                </a>
                {% endif %}
            </nav>
        </div>

        <div class="mt-auto p-3 border-top" style="border-color: var(--border);">
            <div class="d-flex align-items-center gap-3">
                <div class="bg-light rounded-circle d-flex justify-content-center align-items-center fw-bold text-primary" style="width: 40px; height: 40px; border: 1px solid var(--border);">
                    {{ user.full_name|default:request.user.username|slice:":1"|upper }}
                </div>
                <div style="overflow: hidden;">
                    <div class="fw-semibold text-truncate" style="font-size: 0.875rem; color: #0F172A;">{{ user.full_name|default:request.user.username }}</div>
                    <div class="text-truncate text-muted" style="font-size: 0.75rem;">{{ user.email|default:request.user.email }}</div>
                </div>
            </div>
            <!-- Dark Mode Toggle -->
            <div class="dark-toggle" id="darkModeToggle" title="Toggle Dark Mode">
                <span><i class="bi bi-moon-stars me-2"></i>Dark Mode</span>
                <div class="dark-toggle-switch" id="darkToggleSwitch"></div>
            </div>

            <a href="{% url 'logout' %}" class="bb-nav-item text-danger mt-2" style="padding: 0.5rem; justify-content: center; background: var(--danger-bg); border-radius: var(--radius);">
                <i class="bi bi-box-arrow-right"></i> Sign out
            </a>

            <!-- Developer Credit -->
            <div class="text-center mt-3 pt-2" style="border-top: 1px solid var(--border);">
                <span style="font-size: 0.68rem; color: var(--text-light); font-weight: 500; letter-spacing: 0.03em;">
                    üèõÔ∏è Developed by <strong style="color: var(--text-muted);">MSEC</strong>
                </span>
            </div>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="bb-main-content">
        <!-- Flash Messages -->
        <div class="container-fluid mb-3">
            {% if messages %}
                {% for message in messages %}
                <div class="alert alert-{% if message.tags == 'error' %}danger{% else %}{{ message.tags }}{% endif %} alert-dismissible fade show" role="alert" style="border-radius: var(--radius); border: none; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05);">
                    <i class="bi {% if message.tags == 'success' %}bi-check-circle-fill{% elif message.tags == 'error' %}bi-exclamation-triangle-fill{% else %}bi-info-circle-fill{% endif %} me-2"></i>
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
                {% endfor %}
            {% endif %}
        </div>

        {% block content %}
        {% endblock %}
    </main>
</div>

<!-- New SBMS Chatbot UI matching React implementation -->
<div id="gemini-bot-widget" style="position:fixed;bottom:24px;right:24px;z-index:9999;display:flex;flex-direction:column;align-items:flex-end;gap:16px;font-family:'Inter',sans-serif;">

    <!-- Chat Window (Glassmorphism) -->
    <div id="bot-window" style="display:none;width:380px;height:550px;background:rgba(15,23,42,0.85);backdrop-filter:blur(16px);-webkit-backdrop-filter:blur(16px);border-radius:24px;box-shadow:0 0 30px rgba(0,255,255,0.15);border:1px solid rgba(255,255,255,0.1);overflow:hidden;flex-direction:column;transition:all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);transform-origin:bottom right;opacity:0;transform:scale(0.9) translateY(20px);">
        
        <!-- Header -->
        <div style="height:64px;border-bottom:1px solid rgba(255,255,255,0.1);background:rgba(255,255,255,0.05);display:flex;align-items:center;justify-content:space-between;padding:0 16px;">
            <div style="display:flex;align-items:center;gap:12px;">
                <!-- Robot Avatar Placeholder -->
                <div style="width:36px;height:36px;border-radius:50%;background:linear-gradient(135deg,#6366f1,#22d3ee);display:flex;align-items:center;justify-content:center;box-shadow:0 0 15px rgba(34,211,238,0.4);">
                    <i class="bi bi-robot" style="color:white;font-size:1.1rem;"></i>
                </div>
                <div>
                    <h3 style="color:#f1f5f9;font-weight:700;font-size:0.875rem;margin:0;display:flex;align-items:center;gap:4px;">
                        <i class="bi bi-stars" style="color:#818cf8;font-size:0.8rem;"></i> SBMS Assistant
                    </h3>
                    <p style="color:#34d399;font-size:0.75rem;margin:0;display:flex;align-items:center;gap:4px;">
                        <span class="pulse-dot"></span> Online &amp; Ready to Help
                    </p>
                </div>
            </div>
            <button onclick="toggleBotWindow()" style="background:transparent;border:none;color:#94a3b8;cursor:pointer;width:32px;height:32px;border-radius:50%;display:flex;align-items:center;justify-content:center;transition:all 0.2s;" onmouseover="this.style.background='rgba(255,255,255,0.1)';this.style.color='#fff'" onmouseout="this.style.background='transparent';this.style.color='#94a3b8'">
                <i class="bi bi-x-lg"></i>
            </button>
        </div>

        <!-- Messages Area -->
        <div id="bot-messages" style="flex:1;overflow-y:auto;padding:16px;display:flex;flex-direction:column;gap:16px;" class="custom-scrollbar">
            <!-- Default Welcome Message -->
            <div style="display:flex;justify-content:flex-start;animation:slideIn 0.3s ease-out forwards;">
                <div style="max-width:80%;padding:12px;font-size:0.875rem;border-radius:16px;background:rgba(255,255,255,0.1);color:#f1f5f9;border:1px solid rgba(255,255,255,0.05);border-top-left-radius:2px;line-height:1.5;">
                    Namaskar! I am your AI Assistant for the Smart Beneficiary Mapping System. I can help you find government schemes you are eligible for, understand how to apply, or track your applications. How can I help you today?
                </div>
            </div>
        </div>

        <!-- Input Area -->
        <div style="padding:16px;border-top:1px solid rgba(255,255,255,0.1);background:rgba(15,23,42,0.5);">
            <form onsubmit="event.preventDefault(); sendBotMessage();" style="display:flex;align-items:center;gap:8px;margin:0;">
                <input type="text" id="bot-input" placeholder="Ask me anything..." autocomplete="off"
                    style="flex:1;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:12px;padding:12px 16px;color:#f1f5f9;font-size:0.875rem;outline:none;transition:all 0.2s;"
                    onfocus="this.style.borderColor='rgba(34,211,238,0.5)';this.style.boxShadow='0 0 0 1px rgba(34,211,238,0.5)'" 
                    onblur="this.style.borderColor='rgba(255,255,255,0.1)';this.style.boxShadow='none'">
                <button type="submit" id="bot-send-btn"
                    style="background:rgba(6,182,212,0.2);color:#22d3ee;border:1px solid rgba(6,182,212,0.3);border-radius:12px;width:44px;height:44px;display:flex;align-items:center;justify-content:center;cursor:pointer;transition:all 0.2s;flex-shrink:0;"
                    onmouseover="if(!this.disabled){this.style.background='rgba(6,182,212,0.3)';this.style.color='#67e8f9'}"
                    onmouseout="if(!this.disabled){this.style.background='rgba(6,182,212,0.2)';this.style.color='#22d3ee'}">
                    <i class="bi bi-send-fill" style="margin-right:2px;margin-top:2px;"></i>
                </button>
            </form>
        </div>
    </div>

    <!-- Toggle FAB -->
    <button id="bot-fab" onclick="toggleBotWindow()"
        style="width:64px;height:64px;border-radius:50%;background:#0F172A;border:2px solid #22d3ee;color:white;cursor:pointer;display:flex;align-items:center;justify-content:center;box-shadow:0 0 25px rgba(0,255,255,0.4);transition:all 0.3s;outline:none;"
        onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
        <div id="fab-icon-container" style="transition:all 0.3s;">
            <i class="bi bi-robot" style="font-size:1.8rem;color:#22d3ee;"></i>
        </div>
    </button>
</div>

<style>
.pulse-dot { width: 6px; height: 6px; border-radius: 50%; background: #34d399; animation: pulseOp 2s infinite; display: inline-block; }
@keyframes pulseOp { 0%,100%{opacity:1;} 50%{opacity:0.4;} }
@keyframes slideIn { from{opacity:0;transform:translateX(20px);} to{opacity:1;transform:translateX(0);} }
@keyframes slideInLeft { from{opacity:0;transform:translateX(-20px);} to{opacity:1;transform:translateX(0);} }
@keyframes typingBounce { 0%,100%{transform:translateY(0);} 50%{transform:translateY(-5px);} }
.custom-scrollbar::-webkit-scrollbar { width: 6px; }
.custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
.custom-scrollbar::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 10px; }
.custom-scrollbar::-webkit-scrollbar-thumb:hover { background: rgba(255,255,255,0.3); }

/* Message Formatting */
.bot-msg-content b { color: #fff; font-weight: 600; }
.bot-msg-content i { color: #bae6fd; font-style: normal; }
.bot-msg-content br { display: block; margin-bottom: 4px; content: ""; }
</style>

<script>
    function toggleBotWindow() {
        const win = document.getElementById('bot-window');
        const fabBtn = document.getElementById('bot-fab');
        const iconCont = document.getElementById('fab-icon-container');
        const isOpen = win.style.opacity === '1';

        if(isOpen) {
            win.style.opacity = '0';
            win.style.transform = 'scale(0.9) translateY(20px)';
            setTimeout(() => win.style.display = 'none', 300);
            fabBtn.style.background = '#0F172A';
            fabBtn.style.borderColor = '#22d3ee';
            iconCont.innerHTML = '<i class="bi bi-robot" style="font-size:1.8rem;color:#22d3ee;"></i>';
        } else {
            win.style.display = 'flex';
            setTimeout(() => {
                win.style.opacity = '1';
                win.style.transform = 'scale(1) translateY(0)';
            }, 10);
            fabBtn.style.background = '#4f46e5';
            fabBtn.style.borderColor = '#818cf8';
            iconCont.innerHTML = '<i class="bi bi-x-lg" style="font-size:1.6rem;color:white;"></i>';
            document.getElementById('bot-input').focus();
        }
    }

    function renderBotMarkdown(text) {
        return text
            .replace(/\*\*(.*?)\*\*/g, '<b>$1</b>')
            .replace(/\*(.*?)\*/g, '<i>$1</i>')
            .replace(/^#{1,3} (.+)$/gm, '<b style="font-size:1rem;color:#c7d2fe;">$1</b>')
            .replace(/^[-‚Ä¢]\s*(.+)$/gm, '<div style="display:flex;gap:6px;margin:3px 0"><span style="color:#818cf8;font-weight:700">‚Ä¢</span><span>$1</span></div>')
            .replace(/\n\n/g, '<br><br>')
            .replace(/\n/g, '<br>');
    }

    function addMessageUI(text, sender) {
        const chatArea = document.getElementById('bot-messages');
        const wrapper = document.createElement('div');
        wrapper.style.display = 'flex';
        wrapper.style.justifyContent = sender === 'user' ? 'flex-end' : 'flex-start';
        wrapper.style.animation = sender === 'user' ? 'slideIn 0.3s ease-out forwards' : 'slideInLeft 0.3s ease-out forwards';

        const bubble = document.createElement('div');
        if(sender === 'user') {
            bubble.style.cssText = 'max-width:80%;padding:12px;font-size:0.875rem;border-radius:16px;background:#6366f1;color:#fff;border-top-right-radius:2px;box-shadow:0 4px 15px rgba(99,102,241,0.3);line-height:1.5;';
            bubble.textContent = text;
        } else {
            bubble.className = "bot-msg-content";
            bubble.style.cssText = 'max-width:85%;padding:12px;font-size:0.875rem;border-radius:16px;background:rgba(255,255,255,0.1);color:#f1f5f9;border:1px solid rgba(255,255,255,0.05);border-top-left-radius:2px;line-height:1.5;backdrop-filter:blur(8px);-webkit-backdrop-filter:blur(8px);';
            bubble.innerHTML = renderBotMarkdown(text);
        }

        wrapper.appendChild(bubble);
        chatArea.appendChild(wrapper);
        chatArea.scrollTop = chatArea.scrollHeight;
    }

    async function sendBotMessage() {
        const input = document.getElementById('bot-input');
        const btn = document.getElementById('bot-send-btn');
        const msg = input.value.trim();
        if(!msg) return;

        input.value = '';
        input.disabled = true;
        btn.disabled = true;
        btn.style.opacity = '0.5';

        addMessageUI(msg, 'user');

        const chatArea = document.getElementById('bot-messages');
        
        // Typing indicator
        const typingWrapper = document.createElement('div');
        typingWrapper.id = "typing-indicator";
        typingWrapper.style.display = 'flex';
        typingWrapper.style.justifyContent = 'flex-start';
        typingWrapper.style.paddingTop = '8px';
        typingWrapper.innerHTML = `
            <div style="background:rgba(255,255,255,0.1);border:1px solid rgba(255,255,255,0.05);border-radius:16px;border-top-left-radius:2px;padding:12px 16px;backdrop-filter:blur(8px);-webkit-backdrop-filter:blur(8px);display:flex;gap:6px;">
                <div style="width:6px;height:6px;background:#22d3ee;border-radius:50%;animation:typingBounce 0.6s infinite 0s;"></div>
                <div style="width:6px;height:6px;background:#22d3ee;border-radius:50%;animation:typingBounce 0.6s infinite 0.15s;"></div>
                <div style="width:6px;height:6px;background:#22d3ee;border-radius:50%;animation:typingBounce 0.6s infinite 0.3s;"></div>
            </div>`;
        chatArea.appendChild(typingWrapper);
        chatArea.scrollTop = chatArea.scrollHeight;

        try {
            const csrfCookie = document.cookie.split('; ').find(row => row.startsWith('csrftoken='));
            const csrfToken = csrfCookie ? csrfCookie.split('=')[1] : null;

            const headers = { 'Content-Type': 'application/json' };
            if(csrfToken) headers['X-CSRFToken'] = csrfToken;

            const res = await fetch("/api/ai/chat/", {
                method: 'POST',
                headers: headers,
                body: JSON.stringify({ message: msg })
            });
            const data = await res.json();
            document.getElementById('typing-indicator').remove();
            
            addMessageUI(data.reply || data.error || "I couldn't understand that. Please try again.", 'bot');
        } catch(e) {
            document.getElementById('typing-indicator')?.remove();
            addMessageUI("I'm having trouble connecting right now. Please check your internet connection.", 'bot');
        } finally {
            input.disabled = false;
            btn.disabled = false;
            btn.style.opacity = '1';
            input.focus();
        }
    }
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // Sidebar toggle
    document.getElementById('bb-sidebar-toggle')?.addEventListener('click', function() {
        document.querySelector('.bb-sidebar').classList.toggle('active');
        document.querySelector('.bb-sidebar-overlay').classList.toggle('active');
    });
    document.querySelector('.bb-sidebar-overlay')?.addEventListener('click', function() {
        document.querySelector('.bb-sidebar').classList.remove('active');
        this.classList.remove('active');
    });

    // ‚îÄ‚îÄ Dark Mode ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    (function() {
        const html = document.documentElement;
        const DARK_KEY = 'sbms-dark';

        function applyDark(on) {
            html.classList.toggle('dark-mode', on);
            localStorage.setItem(DARK_KEY, on ? '1' : '0');
        }

        // Restore on load (already applied in <head>, but sync the switch UI)
        const isDark = localStorage.getItem(DARK_KEY) === '1';
        applyDark(isDark);

        // Toggle button
        const toggle = document.getElementById('darkModeToggle');
        if (toggle) {
            toggle.addEventListener('click', function() {
                applyDark(!html.classList.contains('dark-mode'));
            });
        }
    })();
</script>
    
    {% block extra_js %}{% endblock %}
</body>
</html>
