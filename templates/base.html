{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Dashboard ‚Äî Smart Beneficiary Mapping System{% endblock %}</title>

    <!-- Apply dark mode BEFORE render to prevent flash of white -->
    <script>
        if (localStorage.getItem('sbms-dark') === '1') {
            document.documentElement.classList.add('dark-mode');
        }
    </script>

    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

    <!-- Bootstrap 5.3 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">

    <!-- Premium CSS System -->
    <link href="{% static 'css/benefitbridge_premium.css' %}" rel="stylesheet">

    <!-- Dark Mode Inline Styles (inlined so always loads regardless of staticfiles) -->
    <style>
        /* ‚îÄ‚îÄ Dark Mode Variables ‚îÄ‚îÄ */
        html.dark-mode {
            --canvas: #0F172A !important;
            --surface: #1E293B !important;
            --text-main: #F1F5F9 !important;
            --text-muted: #94A3B8 !important;
            --text-light: #64748B !important;
            --border: #334155 !important;
            --primary-light: #1E1B4B !important;
            --success-bg: #052E1C !important; --success-text: #6EE7B7 !important;
            --warning-bg: #2D1A00 !important; --warning-text: #FCD34D !important;
            --danger-bg: #2D0A0A !important;  --danger-text: #FCA5A5 !important;
        }
        html.dark-mode body {
            background-color: #0F172A !important;
            color: #F1F5F9 !important;
        }
        html.dark-mode .bb-sidebar     { background: #1E293B !important; border-color: #334155 !important; }
        html.dark-mode .bb-navbar       { background: rgba(15,23,42,0.95) !important; border-color: #334155 !important; }
        html.dark-mode .bb-card         { background: #1E293B !important; border-color: #334155 !important; }
        html.dark-mode .bg-white        { background-color: #1E293B !important; }
        html.dark-mode .bg-light        { background-color: #263044 !important; }
        html.dark-mode .card            { background: #1E293B !important; border-color: #334155 !important; }
        html.dark-mode .form-control,
        html.dark-mode .form-select     { background: #1E293B !important; border-color: #334155 !important; color: #F1F5F9 !important; }
        html.dark-mode .form-control::placeholder { color: #64748B !important; }
        html.dark-mode .input-group-text{ background: #1E293B !important; border-color: #334155 !important; color: #94A3B8 !important; }
        html.dark-mode .table           { color: #F1F5F9 !important; }
        html.dark-mode .table-light th  { background: #263044 !important; color: #94A3B8 !important; }
        html.dark-mode .table-hover tbody tr:hover { background: rgba(99,102,241,0.1) !important; }
        html.dark-mode .border          { border-color: #334155 !important; }
        html.dark-mode .border-top,
        html.dark-mode .border-bottom   { border-color: #334155 !important; }
        html.dark-mode .text-dark       { color: #F1F5F9 !important; }
        html.dark-mode .text-muted      { color: #94A3B8 !important; }
        html.dark-mode .fw-semibold[style*="#0F172A"],
        html.dark-mode [style*="color: #0F172A"],
        html.dark-mode [style*="color:#0F172A"] { color: #F1F5F9 !important; }
        html.dark-mode .alert           { background: #1E293B !important; border-color: #334155 !important; }
        html.dark-mode .bb-nav-item     { color: #94A3B8 !important; }
        html.dark-mode .bb-nav-item:hover,
        html.dark-mode .bb-nav-item.active { background: rgba(99,102,241,0.15) !important; color: #818CF8 !important; }
        html.dark-mode .shadow-sm,
        html.dark-mode .shadow,
        html.dark-mode .shadow-lg       { box-shadow: 0 4px 12px rgba(0,0,0,0.5) !important; }
        html.dark-mode .bb-stat-card    { background: #1E293B !important; }

        /* Dark mode toggle */
        .dark-toggle {
            display: flex; align-items: center; justify-content: space-between;
            padding: 0.55rem 0.75rem; border-radius: 10px;
            cursor: pointer; user-select: none;
            color: var(--text-muted); font-size: 0.85rem; font-weight: 600;
            margin-bottom: 0.5rem; transition: background 0.2s;
        }
        .dark-toggle:hover { background: var(--primary-light); color: var(--primary); }
        .dark-toggle-switch {
            width: 40px; height: 22px; border-radius: 11px;
            background: #CBD5E1; position: relative; transition: background 0.3s; flex-shrink:0;
        }
        .dark-toggle-switch::after {
            content: ''; position: absolute; top: 3px; left: 3px;
            width: 16px; height: 16px; border-radius: 50%;
            background: white; transition: transform 0.25s;
            box-shadow: 0 1px 3px rgba(0,0,0,0.25);
        }
        html.dark-mode .dark-toggle-switch { background: #4F46E5; }
        html.dark-mode .dark-toggle-switch::after { transform: translateX(18px); }
        html.dark-mode .dark-toggle { color: #818CF8; }

        /* Smooth fade between modes */
        body, .bb-card, .bb-sidebar, .bb-navbar, .form-control, .form-select {
            transition: background-color 0.25s ease, color 0.2s ease, border-color 0.2s ease !important;
        }
    </style>

    {% block extra_css %}{% endblock %}
</head>
<body>

    <!-- Mobile Top Navbar -->
    <nav class="bb-navbar">
        <a href="{% url 'dashboard' %}" class="d-flex align-items-center text-decoration-none" style="gap: 0.6rem; color: #0F172A; font-weight: 700; font-size: 0.95rem;">
            <div style="width:34px; height:34px; border-radius:8px; background: var(--primary); display:flex; align-items:center; justify-content:center; flex-shrink:0; box-shadow: 0 2px 8px rgba(30,58,138,0.25);">
                <i class="bi bi-bank2" style="font-size: 1.1rem; color: white;"></i>
            </div>
            <span style="line-height:1.2;">Smart Beneficiary<br><span style="font-size:0.75rem; font-weight:500; color:var(--text-light);">Mapping System</span></span>
        </a>
        <button id="bb-sidebar-toggle" class="bb-btn" style="padding: 0.5rem; color: var(--text-main); background: transparent; box-shadow: none;">
            <i class="bi bi-list fs-4"></i>
        </button>
    </nav>

    <!-- Sidebar -->
    <aside class="bb-sidebar">
        <div class="d-flex flex-column" style="padding: 1.5rem 1rem; flex: 1; overflow-y: auto;">
            <!-- Logo -->
            <a href="{% url 'dashboard' %}" class="d-flex align-items-center text-decoration-none mb-4" style="gap: 0.75rem; color: #0F172A; font-weight: 700; font-size: 1rem;">
                <div style="width:42px; height:42px; border-radius:10px; background: var(--primary); display:flex; align-items:center; justify-content:center; flex-shrink:0; box-shadow: 0 4px 12px rgba(30,58,138,0.3);">
                    <i class="bi bi-bank2" style="font-size: 1.3rem; color: white;"></i>
                </div>
                <span style="line-height:1.25;">Smart Beneficiary<br><span style="font-size:0.75rem; font-weight:500; color:var(--text-light); letter-spacing:0.01em;">Mapping System</span></span>
            </a>

            <!-- Navigation Links -->
            <nav class="d-flex flex-column" style="gap: 0.25rem;">
                {% if not request.user.is_superuser %}
                <a href="{% url 'dashboard' %}" class="bb-nav-item {% if request.resolver_match.url_name == 'dashboard' %}active{% endif %}">
                    <i class="bi bi-grid-1x2"></i> Dashboard
                </a>
                <a href="{% url 'categories' %}" class="bb-nav-item {% if request.resolver_match.url_name == 'categories' %}active{% endif %}">
                    <i class="bi bi-search"></i> Search Schemes
                </a>
                <a href="{% url 'my_applications' %}" class="bb-nav-item {% if request.resolver_match.url_name == 'my_applications' %}active{% endif %}">
                    <i class="bi bi-file-earmark-check"></i> My Applications
                </a>
                <a href="{% url 'my_grievances' %}" class="bb-nav-item {% if request.resolver_match.url_name == 'my_grievances' %}active{% endif %}">
                    <i class="bi bi-exclamation-circle"></i> My Grievances
                </a>
                <a href="{% url 'edit_profile' %}" class="bb-nav-item {% if request.resolver_match.url_name == 'edit_profile' %}active{% endif %}">
                    <i class="bi bi-person-badge"></i> Edit Profile
                </a>
                {% endif %}
                {% if request.user.is_superuser %}
                <div class="mt-3 mb-2 px-3 text-uppercase" style="font-size: 0.7rem; font-weight: 700; color: var(--text-light); letter-spacing: 0.05em;">Admin</div>
                <a href="{% url 'admin_stats' %}" class="bb-nav-item {% if request.resolver_match.url_name == 'admin_stats' %}active{% endif %}">
                    <i class="bi bi-pie-chart"></i> Platform Stats
                </a>
                <a href="{% url 'admin_users' %}" class="bb-nav-item {% if request.resolver_match.url_name == 'admin_users' %}active{% endif %}">
                    <i class="bi bi-people"></i> Manage Users
                </a>
                <a href="{% url 'admin_schemes' %}" class="bb-nav-item {% if 'scheme' in request.resolver_match.url_name %}active{% endif %}">
                    <i class="bi bi-card-list"></i> Manage Schemes
                </a>
                <a href="{% url 'admin_grievances' %}" class="bb-nav-item {% if request.resolver_match.url_name == 'admin_grievances' %}active{% endif %}">
                    <i class="bi bi-inbox"></i> Manage Grievances
                </a>
                <a href="{% url 'admin_announcements' %}" class="bb-nav-item {% if request.resolver_match.url_name == 'admin_announcements' %}active{% endif %}">
                    <i class="bi bi-megaphone"></i> Announcements
                </a>
                <a href="/admin/" class="bb-nav-item">
                    <i class="bi bi-gear"></i> Django Admin
                </a>
                {% endif %}
            </nav>
        </div>

        <div class="mt-auto p-3 border-top" style="border-color: var(--border);">
            <div class="d-flex align-items-center gap-3">
                <div class="bg-light rounded-circle d-flex justify-content-center align-items-center fw-bold text-primary" style="width: 40px; height: 40px; border: 1px solid var(--border);">
                    {{ user.full_name|default:request.user.username|slice:":1"|upper }}
                </div>
                <div style="overflow: hidden;">
                    <div class="fw-semibold text-truncate" style="font-size: 0.875rem; color: #0F172A;">{{ user.full_name|default:request.user.username }}</div>
                    <div class="text-truncate text-muted" style="font-size: 0.75rem;">{{ user.email|default:request.user.email }}</div>
                </div>
            </div>
            <!-- Dark Mode Toggle -->
            <div class="dark-toggle" id="darkModeToggle" title="Toggle Dark Mode">
                <span><i class="bi bi-moon-stars me-2"></i>Dark Mode</span>
                <div class="dark-toggle-switch" id="darkToggleSwitch"></div>
            </div>

            <a href="{% url 'logout' %}" class="bb-nav-item text-danger mt-2" style="padding: 0.5rem; justify-content: center; background: var(--danger-bg); border-radius: var(--radius);">
                <i class="bi bi-box-arrow-right"></i> Sign out
            </a>

            <!-- Developer Credit -->
            <div class="text-center mt-3 pt-2" style="border-top: 1px solid var(--border);">
                <span style="font-size: 0.68rem; color: var(--text-light); font-weight: 500; letter-spacing: 0.03em;">
                    üèõÔ∏è Developed by <strong style="color: var(--text-muted);">MSEC</strong>
                </span>
            </div>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="bb-main-content">
        <!-- Flash Messages -->
        <div class="container-fluid mb-3">
            {% if messages %}
                {% for message in messages %}
                <div class="alert alert-{% if message.tags == 'error' %}danger{% else %}{{ message.tags }}{% endif %} alert-dismissible fade show" role="alert" style="border-radius: var(--radius); border: none; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05);">
                    <i class="bi {% if message.tags == 'success' %}bi-check-circle-fill{% elif message.tags == 'error' %}bi-exclamation-triangle-fill{% else %}bi-info-circle-fill{% endif %} me-2"></i>
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
                {% endfor %}
            {% endif %}
        </div>

        {% block content %}
        {% endblock %}
    </main>
</div>

<!-- SBMS AI Assistant Widget -->
<div id="sbms-chat-widget" style="position:fixed;bottom:28px;right:28px;z-index:9999;display:flex;flex-direction:column;align-items:flex-end;gap:14px;">

    <!-- Chat Window -->
    <div id="sbms-chat-window" style="display:none;width:360px;height:540px;background:#fff;border-radius:20px;box-shadow:0 12px 48px rgba(79,70,229,0.18),0 0 0 1px rgba(79,70,229,0.08);overflow:hidden;flex-direction:column;border:1.5px solid #e0e7ff;">

        <!-- Header -->
        <div style="background:linear-gradient(135deg,#4f46e5 0%,#6366f1 100%);color:#fff;padding:14px 16px;display:flex;justify-content:space-between;align-items:center;">
            <div style="display:flex;align-items:center;gap:12px;">
                <!-- Animated Robot Avatar -->
                <div id="sbms-avatar" style="position:relative;width:40px;height:40px;flex-shrink:0;">
                    <div style="position:absolute;inset:0;border-radius:50%;border:2px solid rgba(99,220,255,0.7);animation:avatarPulse 2s ease-in-out infinite;"></div>
                    <div style="position:relative;z-index:1;width:36px;height:30px;margin:4px auto 0;background:#0f172a;border:2px solid #22d3ee;border-radius:12px;display:flex;flex-direction:column;align-items:center;justify-content:center;overflow:visible;box-shadow:0 0 10px rgba(34,211,238,0.4);">
                        <!-- Antenna -->
                        <div style="position:absolute;top:-10px;width:2px;height:8px;background:#22d3ee;">
                            <div id="sbms-antenna-tip" style="position:absolute;top:-4px;left:-3px;width:8px;height:8px;background:#6366f1;border:1px solid #22d3ee;border-radius:50%;"></div>
                        </div>
                        <!-- Eyes -->
                        <div style="display:flex;gap:6px;margin-top:4px;">
                            <div class="sbms-eye" style="width:8px;height:6px;background:#22d3ee;border-radius:50%;"></div>
                            <div class="sbms-eye" style="width:8px;height:6px;background:#22d3ee;border-radius:50%;"></div>
                        </div>
                        <!-- Mouth -->
                        <div id="sbms-mouth" style="width:12px;height:2px;background:#22d3ee;border-radius:2px;margin-top:4px;transition:all 0.3s;"></div>
                    </div>
                </div>
                <div>
                    <div style="font-weight:700;font-size:0.95rem;letter-spacing:0.02em;">‚ú® SBMS Assistant</div>
                    <div style="font-size:0.72rem;color:#a5f3fc;display:flex;align-items:center;gap:5px;">
                        <span style="width:6px;height:6px;border-radius:50%;background:#4ade80;animation:pulse 1.5s infinite;display:inline-block;"></span>
                        Online &amp; Ready to Help
                    </div>
                </div>
            </div>
            <button onclick="toggleSBMSChat()" style="background:rgba(255,255,255,0.15);border:none;color:white;cursor:pointer;width:30px;height:30px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:1rem;">&times;</button>
        </div>

        <!-- Messages -->
        <div id="sbms-messages" style="flex:1;padding:14px;overflow-y:auto;background:#f8faff;display:flex;flex-direction:column;gap:10px;font-size:0.875rem;">
            <!-- Welcome message -->
            <div style="background:#fff;padding:12px 15px;border-radius:16px;border-bottom-left-radius:4px;max-width:88%;align-self:flex-start;border:1px solid #e0e7ff;color:#1e293b;line-height:1.5;box-shadow:0 2px 8px rgba(79,70,229,0.06);">
                üôè <b>Namaskar!</b> I am your AI Assistant for the <b>Smart Beneficiary Mapping System</b>.<br><br>
                I can help you find government schemes you are eligible for, understand how to apply, or track your applications. How can I help you today?
            </div>
        </div>

        <!-- Input -->
        <div style="padding:12px 14px;background:#fff;border-top:1px solid #e0e7ff;display:flex;gap:8px;align-items:center;">
            <input type="text" id="sbms-input" placeholder="Ask me anything..." autocomplete="off"
                style="flex:1;border:1.5px solid #e0e7ff;border-radius:22px;padding:9px 16px;outline:none;font-size:0.875rem;color:#1e293b;background:#f8faff;transition:border-color 0.2s;"
                onfocus="this.style.borderColor='#6366f1'" onblur="this.style.borderColor='#e0e7ff'"
                onkeypress="if(event.key==='Enter')sendSBMSMessage()">
            <button id="sbms-send-btn" onclick="sendSBMSMessage()"
                style="background:#4f46e5;border:none;color:white;cursor:pointer;width:40px;height:40px;border-radius:50%;display:flex;align-items:center;justify-content:center;flex-shrink:0;box-shadow:0 4px 12px rgba(79,70,229,0.35);transition:all 0.2s;"
                onmouseover="this.style.background='#4338ca'" onmouseout="this.style.background='#4f46e5'">
                <i class="bi bi-send-fill" style="font-size:0.9rem;"></i>
            </button>
        </div>
    </div>

    <!-- Toggle FAB Button -->
    <button id="sbms-fab" onclick="toggleSBMSChat()"
        style="width:60px;height:60px;border-radius:50%;background:#0f172a;border:2.5px solid #22d3ee;color:white;cursor:pointer;display:flex;align-items:center;justify-content:center;box-shadow:0 0 20px rgba(34,211,238,0.45),0 8px 20px rgba(0,0,0,0.3);transition:all 0.3s;"
        onmouseover="this.style.transform='scale(1.08)'" onmouseout="this.style.transform='scale(1)'">
        <i class="bi bi-robot" style="font-size:1.6rem;color:#22d3ee;"></i>
    </button>
</div>

<style>
@keyframes avatarPulse { 0%,100%{opacity:0.25;transform:scale(1);} 50%{opacity:0.6;transform:scale(1.18);} }
@keyframes pulse { 0%,100%{opacity:1;} 50%{opacity:0.4;} }
@keyframes eyeBlink { 0%,90%,100%{transform:scaleY(1);} 95%{transform:scaleY(0.15);} }
@keyframes typingDot { 0%,100%{transform:translateY(0);opacity:0.5;} 50%{transform:translateY(-5px);opacity:1;} }
.sbms-eye { animation: eyeBlink 4s ease-in-out infinite; }
.sbms-eye:nth-child(2) { animation-delay: 0.1s; }
</style>

<script>
    function toggleSBMSChat() {
        const win = document.getElementById('sbms-chat-window');
        const fab = document.getElementById('sbms-fab');
        const isOpen = win.style.display !== 'none' && win.style.display !== '';
        win.style.display = isOpen ? 'none' : 'flex';
        if (!isOpen) {
            fab.style.borderColor = '#6366f1';
            document.getElementById('sbms-input').focus();
        } else {
            fab.style.borderColor = '#22d3ee';
        }
    }

    function renderMarkdown(text) {
        return text
            .replace(/\*\*(.*?)\*\*/g, '<b>$1</b>')
            .replace(/\*(.*?)\*/g, '<i>$1</i>')
            .replace(/^#{1,3} (.+)$/gm, '<b style="font-size:1rem">$1</b>')
            .replace(/^[-‚Ä¢] (.+)$/gm, '<div style="display:flex;gap:6px;margin:2px 0"><span style="color:#4f46e5;font-weight:700">‚Ä¢</span><span>$1</span></div>')
            .replace(/\n/g, '<br>');
    }

    function addSBMSMessage(text, sender) {
        const div = document.getElementById('sbms-messages');
        const isBot = sender === 'bot';
        const bubble = document.createElement('div');
        bubble.style.cssText = isBot
            ? 'background:#fff;padding:12px 15px;border-radius:16px;border-bottom-left-radius:4px;max-width:88%;align-self:flex-start;border:1px solid #e0e7ff;color:#1e293b;line-height:1.6;box-shadow:0 2px 8px rgba(79,70,229,0.06);'
            : 'background:linear-gradient(135deg,#4f46e5,#6366f1);padding:10px 15px;border-radius:16px;border-bottom-right-radius:4px;max-width:85%;align-self:flex-end;color:#fff;line-height:1.5;box-shadow:0 4px 12px rgba(79,70,229,0.3);';
        bubble.innerHTML = isBot ? renderMarkdown(text) : text.replace(/</g,'&lt;');
        div.appendChild(bubble);
        div.scrollTop = div.scrollHeight;
        return bubble;
    }

    function setRobotAnimation(isTyping) {
        document.querySelectorAll('.sbms-eye').forEach(eye => {
            eye.style.animation = isTyping
                ? 'eyeBlink 0.5s ease-in-out infinite'
                : 'eyeBlink 4s ease-in-out infinite';
        });
        const mouth = document.getElementById('sbms-mouth');
        if (mouth) mouth.style.height = isTyping ? '6px' : '2px';
    }

    async function sendSBMSMessage() {
        const input = document.getElementById('sbms-input');
        const msg = input.value.trim();
        if (!msg) return;

        input.value = '';
        input.disabled = true;
        document.getElementById('sbms-send-btn').disabled = true;

        addSBMSMessage(msg, 'user');
        setRobotAnimation(true);

        // Typing indicator
        const msgDiv = document.getElementById('sbms-messages');
        const loader = document.createElement('div');
        loader.style.cssText = 'background:#fff;padding:12px 15px;border-radius:16px;border-bottom-left-radius:4px;align-self:flex-start;border:1px solid #e0e7ff;display:flex;gap:6px;align-items:center;box-shadow:0 2px 8px rgba(79,70,229,0.06);';
        loader.innerHTML = ['#22d3ee','#6366f1','#4f46e5'].map((c,i) =>
            `<div style="width:8px;height:8px;background:${c};border-radius:50%;animation:typingDot 0.8s ease-in-out infinite;animation-delay:${i*0.2}s;"></div>`
        ).join('');
        msgDiv.appendChild(loader);
        msgDiv.scrollTop = msgDiv.scrollHeight;

        try {
            const fd = new FormData();
            fd.append('message', msg);
            fd.append('csrfmiddlewaretoken', '{{ csrf_token }}');

            const res = await fetch("{% url 'gemini_chat' %}", { method: 'POST', body: fd });
            const data = await res.json();
            loader.remove();
            addSBMSMessage(data.reply || data.error || 'Sorry, something went wrong.', 'bot');
        } catch(e) {
            loader.remove();
            addSBMSMessage("I'm having trouble connecting right now. Please check your internet connection.", 'bot');
        } finally {
            setRobotAnimation(false);
            input.disabled = false;
            document.getElementById('sbms-send-btn').disabled = false;
            input.focus();
        }
    }
</script>




<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // Sidebar toggle
    document.getElementById('bb-sidebar-toggle')?.addEventListener('click', function() {
        document.querySelector('.bb-sidebar').classList.toggle('active');
        document.querySelector('.bb-sidebar-overlay').classList.toggle('active');
    });
    document.querySelector('.bb-sidebar-overlay')?.addEventListener('click', function() {
        document.querySelector('.bb-sidebar').classList.remove('active');
        this.classList.remove('active');
    });

    // ‚îÄ‚îÄ Dark Mode ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    (function() {
        const html = document.documentElement;
        const DARK_KEY = 'sbms-dark';

        function applyDark(on) {
            html.classList.toggle('dark-mode', on);
            localStorage.setItem(DARK_KEY, on ? '1' : '0');
        }

        // Restore on load (already applied in <head>, but sync the switch UI)
        const isDark = localStorage.getItem(DARK_KEY) === '1';
        applyDark(isDark);

        // Toggle button
        const toggle = document.getElementById('darkModeToggle');
        if (toggle) {
            toggle.addEventListener('click', function() {
                applyDark(!html.classList.contains('dark-mode'));
            });
        }
    })();
</script>
    
    {% block extra_js %}{% endblock %}
</body>
</html>
